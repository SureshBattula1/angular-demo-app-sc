<div class="page-container">
  <div class="page-header">
    <h1 class="page-title">
      <mat-icon>person</mat-icon>
      User Details
    </h1>
    <div class="header-actions">
      <button mat-stroked-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back
      </button>
      <button 
        mat-raised-button 
        color="accent" 
        (click)="editUser()"
        *hasPermission="'users.update'">
        <mat-icon>edit</mat-icon>
        Edit
      </button>
      <button 
        mat-raised-button 
        color="warn" 
        (click)="deleteUser()"
        *hasPermission="'users.delete'">
        <mat-icon>delete</mat-icon>
        Delete
      </button>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
  </div>

  <div *ngIf="!isLoading && user">
    <!-- User Info Card -->
    <mat-card class="info-card">
      <mat-card-header>
        <mat-card-title>Personal Information</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <span class="label">ID:</span>
            <span class="value">{{ user.id }}</span>
          </div>
          <div class="info-item">
            <span class="label">Full Name:</span>
            <span class="value">{{ getUserFullName() }}</span>
          </div>
          <div class="info-item">
            <span class="label">First Name:</span>
            <span class="value">{{ user.first_name }}</span>
          </div>
          <div class="info-item">
            <span class="label">Last Name:</span>
            <span class="value">{{ user.last_name }}</span>
          </div>
          <div class="info-item">
            <span class="label">Email:</span>
            <span class="value">{{ user.email }}</span>
          </div>
          <div class="info-item">
            <span class="label">Username:</span>
            <span class="value">{{ user.username || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Role:</span>
            <span class="value">
              <mat-chip color="primary">{{ user.role || 'N/A' }}</mat-chip>
            </span>
          </div>
          <div class="info-item">
            <span class="label">Branch:</span>
            <span class="value">{{ user.branch?.name || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Status:</span>
            <span class="value">
              <mat-chip [color]="getStatusColor()">{{ getStatusText() }}</mat-chip>
            </span>
          </div>
          <div class="info-item">
            <span class="label">Email Verified:</span>
            <span class="value">{{ user.email_verified_at ? 'Yes' : 'No' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Created:</span>
            <span class="value">{{ user.created_at | date:'medium' }}</span>
          </div>
          <div class="info-item">
            <span class="label">Updated:</span>
            <span class="value">{{ user.updated_at | date:'medium' }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Role & Permissions Section -->
    <div class="permissions-section" *ngIf="userRole">
      <div class="section-header">
        <h2>
          <mat-icon>admin_panel_settings</mat-icon>
          Role & Permissions
        </h2>
      </div>

      <!-- Role Info Card -->
      <mat-card class="role-info-card">
        <mat-card-header>
          <mat-card-title>Assigned Role</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="role-badge">
            <mat-icon class="role-icon">admin_panel_settings</mat-icon>
            <div class="role-details">
              <h3>{{ userRole.name }}</h3>
              <p *ngIf="userRole.description">{{ userRole.description }}</p>
              <span class="permissions-count">
                {{ userRole.permissions?.length || 0 }} 
                {{ (userRole.permissions?.length === 1) ? 'Permission' : 'Permissions' }}
              </span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Permissions Grid -->
      <div class="section-header">
        <h2>Assigned Permissions ({{ userRole.permissions?.length || 0 }})</h2>
      </div>

      <div *ngIf="!userRole.permissions || userRole.permissions.length === 0" class="no-permissions-message">
        <mat-card class="empty-state-card">
          <mat-card-content>
            <mat-icon>shield_off</mat-icon>
            <h3>No Permissions Assigned</h3>
            <p>This role currently has no permissions assigned.</p>
          </mat-card-content>
        </mat-card>
      </div>

      <div *ngIf="userRole.permissions && userRole.permissions.length > 0" class="permissions-grid">
        <mat-card *ngFor="let moduleKey of getModules()" class="module-card">
          <mat-card-header>
            <div class="module-header-content">
              <mat-icon class="module-icon">{{ getModuleIcon(moduleKey) }}</mat-icon>
              <div class="module-info">
                <h3 class="module-title">{{ getModuleDisplayName(moduleKey) }}</h3>
                <p class="module-subtitle">
                  {{ permissionsByModule[moduleKey].length }} 
                  {{ permissionsByModule[moduleKey].length === 1 ? 'Permission' : 'Permissions' }}
                </p>
              </div>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="permissions-list">
              <div *ngFor="let permission of permissionsByModule[moduleKey]; let isLast = last" 
                   class="permission-row"
                   [class.last]="isLast">
                <mat-icon class="check-icon">check_circle</mat-icon>
                <span class="permission-text">{{ permission.display_name || permission.name }}</span>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Actions Card -->
    <mat-card class="actions-card" *hasPermission="'users.update'">
      <mat-card-header>
        <mat-card-title>Quick Actions</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="actions-grid">
          <button mat-raised-button color="primary" (click)="toggleStatus()">
            <mat-icon>{{ user.is_active ? 'block' : 'check_circle' }}</mat-icon>
            {{ user.is_active ? 'Deactivate User' : 'Activate User' }}
          </button>
          <button mat-raised-button (click)="editUser()">
            <mat-icon>vpn_key</mat-icon>
            Reset Password
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

