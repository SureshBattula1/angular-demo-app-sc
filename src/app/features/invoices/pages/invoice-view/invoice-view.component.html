<div class="invoice-view-container">
  <mat-card class="invoice-card" *ngIf="invoice && !loading">
    <!-- Invoice Header -->
    <div class="invoice-header printable">
      <div class="header-left">
        <h1>INVOICE</h1>
        <p class="invoice-number">#{{ invoice.invoice_number }}</p>
      </div>
      <div class="header-right">
        <mat-chip-set>
          <mat-chip [class]="'status-' + invoice.status.toLowerCase()">{{ invoice.status }}</mat-chip>
          <mat-chip [class]="'payment-' + invoice.payment_status.toLowerCase()">{{ invoice.payment_status }}</mat-chip>
          <mat-chip *ngIf="invoice.is_overdue" class="overdue-chip">OVERDUE</mat-chip>
        </mat-chip-set>
      </div>
    </div>

    <mat-divider></mat-divider>

    <!-- Company & Customer Info -->
    <div class="info-section printable">
      <div class="info-block">
        <h3>From:</h3>
        <p><strong>{{ invoice.branch?.name || 'School Name' }}</strong></p>
        <p class="small">Branch Code: {{ invoice.branch?.code }}</p>
      </div>

      <div class="info-block">
        <h3>Bill To:</h3>
        <p><strong>{{ invoice.customer_name }}</strong></p>
        <p class="small" *ngIf="invoice.customer_email">{{ invoice.customer_email }}</p>
        <p class="small" *ngIf="invoice.customer_phone">{{ invoice.customer_phone }}</p>
        <p class="small" *ngIf="invoice.customer_address">{{ invoice.customer_address }}</p>
      </div>

      <div class="info-block">
        <h3>Invoice Details:</h3>
        <p><strong>Date:</strong> {{ invoice.invoice_date | date:'mediumDate' }}</p>
        <p><strong>Due:</strong> {{ invoice.due_date | date:'mediumDate' }}</p>
        <p><strong>Type:</strong> {{ invoice.invoice_type }}</p>
      </div>
    </div>

    <mat-divider></mat-divider>

    <!-- Items Table -->
    <div class="items-section printable">
      <h3>Invoice Items</h3>
      <table mat-table [dataSource]="invoice.items || []" class="items-table">
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let item">{{ item.description }}</td>
        </ng-container>

        <ng-container matColumnDef="quantity">
          <th mat-header-cell *matHeaderCellDef class="text-center">Qty</th>
          <td mat-cell *matCellDef="let item" class="text-center">{{ item.quantity }}</td>
        </ng-container>

        <ng-container matColumnDef="unit_price">
          <th mat-header-cell *matHeaderCellDef class="text-right">Price</th>
          <td mat-cell *matCellDef="let item" class="text-right">₹{{ item.unit_price | number:'1.2-2' }}</td>
        </ng-container>

        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef class="text-right">Amount</th>
          <td mat-cell *matCellDef="let item" class="text-right">₹{{ item.amount | number:'1.2-2' }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </div>

    <!-- Totals -->
    <div class="totals-section printable">
      <div class="totals-details">
        <div class="total-row">
          <span>Subtotal:</span>
          <span>₹{{ invoice.subtotal | number:'1.2-2' }}</span>
        </div>
        <div class="total-row" *ngIf="invoice.tax_amount > 0">
          <span>Tax ({{ invoice.tax_percentage }}%):</span>
          <span>₹{{ invoice.tax_amount | number:'1.2-2' }}</span>
        </div>
        <div class="total-row" *ngIf="invoice.discount_amount > 0">
          <span>Discount ({{ invoice.discount_percentage }}%):</span>
          <span>-₹{{ invoice.discount_amount | number:'1.2-2' }}</span>
        </div>
        <mat-divider></mat-divider>
        <div class="total-row grand-total">
          <span>Total Amount:</span>
          <strong>₹{{ invoice.total_amount | number:'1.2-2' }}</strong>
        </div>
        <div class="total-row paid" *ngIf="invoice.paid_amount > 0">
          <span>Paid:</span>
          <span>₹{{ invoice.paid_amount | number:'1.2-2' }}</span>
        </div>
        <div class="total-row balance" *ngIf="invoice.balance_amount > 0">
          <span>Balance Due:</span>
          <strong>₹{{ invoice.balance_amount | number:'1.2-2' }}</strong>
        </div>
      </div>
    </div>

    <!-- Linked Transactions (if any) -->
    <div class="linked-transactions" *ngIf="invoice.transactions && invoice.transactions.length > 0">
      <h4><mat-icon>link</mat-icon> Linked Transactions ({{ invoice.transactions.length }})</h4>
      <div class="transaction-chips">
        <mat-chip *ngFor="let trans of invoice.transactions">
          {{ trans.transaction_number }}
        </mat-chip>
      </div>
    </div>

    <!-- Actions -->
    <mat-card-actions align="end" class="no-print">
      <button mat-button (click)="onBack()">
        <mat-icon>arrow_back</mat-icon> Back
      </button>
      <button mat-button (click)="onPrint()">
        <mat-icon>print</mat-icon> Print
      </button>
      <button mat-raised-button *ngIf="invoice.status === 'Draft'" (click)="onSend()">
        <mat-icon>send</mat-icon> Send
      </button>
    </mat-card-actions>
  </mat-card>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
  </div>
</div>

