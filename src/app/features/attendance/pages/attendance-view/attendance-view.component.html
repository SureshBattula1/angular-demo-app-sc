<div class="page-container">
  <!-- Single Attendance View -->
  <mat-card *ngIf="!showReport && attendance" class="view-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>fact_check</mat-icon>
        Attendance Details
      </mat-card-title>
    </mat-card-header>

    <mat-divider></mat-divider>

    <mat-card-content>
      <div class="details-grid">
        <div class="detail-item">
          <mat-icon>event</mat-icon>
          <div>
            <label>Date</label>
            <span>{{ attendance.date | date:'mediumDate' }}</span>
          </div>
        </div>

        <div class="detail-item" *ngIf="isStudentAttendance(attendance)">
          <mat-icon>person</mat-icon>
          <div>
            <label>Student Name</label>
            <span>{{ attendance.first_name }} {{ attendance.last_name }}</span>
          </div>
        </div>

        <div class="detail-item" *ngIf="isStudentAttendance(attendance)">
          <mat-icon>badge</mat-icon>
          <div>
            <label>Admission Number</label>
            <span>{{ attendance.admission_number }}</span>
          </div>
        </div>

        <div class="detail-item" *ngIf="isStudentAttendance(attendance)">
          <mat-icon>grade</mat-icon>
          <div>
            <label>Grade & Section</label>
            <span>Grade {{ attendance.grade }} - Section {{ attendance.section }}</span>
          </div>
        </div>

        <div class="detail-item">
          <mat-icon>info</mat-icon>
          <div>
            <label>Status</label>
            <mat-chip [color]="getStatusColor(attendance.status)">{{ attendance.status }}</mat-chip>
          </div>
        </div>

        <div class="detail-item" *ngIf="attendance.remarks">
          <mat-icon>comment</mat-icon>
          <div>
            <label>Remarks</label>
            <span>{{ attendance.remarks }}</span>
          </div>
        </div>

        <div class="detail-item" *ngIf="isStudentAttendance(attendance) && attendance.marked_by">
          <mat-icon>person_add</mat-icon>
          <div>
            <label>Marked By</label>
            <span>{{ attendance.marked_by }}</span>
          </div>
        </div>
      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button (click)="onBack()">
        <mat-icon>arrow_back</mat-icon> Back to List
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Student Attendance Report -->
  <mat-card *ngIf="showReport" class="report-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>assessment</mat-icon>
        Student Attendance Report
      </mat-card-title>
      <mat-card-subtitle>
        Monthly attendance summary and history
        <span *ngIf="summary"> ({{ summary.total_days }} days tracked)</span>
      </mat-card-subtitle>
    </mat-card-header>

    <mat-divider></mat-divider>

    <mat-card-content>
      <!-- Summary Stats -->
      <div class="summary-section" *ngIf="summary && !loading">
        <h3>
          <mat-icon>insights</mat-icon>
          Summary Statistics
        </h3>
        <div class="stats-grid">
          <mat-card class="stat-card">
            <mat-icon class="stat-icon">event</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ summary.total_days || 0 }}</span>
              <span class="stat-label">Total Days</span>
            </div>
          </mat-card>

          <mat-card class="stat-card success">
            <mat-icon class="stat-icon">check_circle</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ summary.present || 0 }}</span>
              <span class="stat-label">Present</span>
            </div>
          </mat-card>

          <mat-card class="stat-card danger">
            <mat-icon class="stat-icon">cancel</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ summary.absent || 0 }}</span>
              <span class="stat-label">Absent</span>
            </div>
          </mat-card>

          <mat-card class="stat-card warning">
            <mat-icon class="stat-icon">schedule</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ summary.late || 0 }}</span>
              <span class="stat-label">Late</span>
            </div>
          </mat-card>

          <mat-card class="stat-card info" *ngIf="summary.leaves">
            <mat-icon class="stat-icon">event_busy</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ summary.leaves || 0 }}</span>
              <span class="stat-label">Leaves</span>
            </div>
          </mat-card>

          <mat-card class="stat-card" [ngClass]="getPercentageColor()">
            <mat-icon class="stat-icon">percent</mat-icon>
            <div class="stat-content">
              <span class="stat-value">{{ getAttendancePercentage() | number:'1.0-2' }}%</span>
              <span class="stat-label">Attendance Rate</span>
            </div>
          </mat-card>
        </div>
      </div>

      <!-- Attendance History -->
      <div class="history-section" *ngIf="!loading && attendanceHistory.length > 0">
        <h3>
          <mat-icon>history</mat-icon>
          Attendance History ({{ attendanceHistory.length }} records)
        </h3>
        <div class="table-container">
          <table mat-table [dataSource]="attendanceHistory" class="history-table">
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let record">{{ record.date | date:'mediumDate' }}</td>
            </ng-container>

            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let record">
                <mat-chip [class]="'status-' + getStatusColor(record.status)">
                  <mat-icon class="chip-icon">{{ getStatusIcon(record.status) }}</mat-icon>
                  {{ record.status }}
                </mat-chip>
              </td>
            </ng-container>

            <ng-container matColumnDef="remarks">
              <th mat-header-cell *matHeaderCellDef>Remarks</th>
              <td mat-cell *matCellDef="let record">{{ record.remarks || '-' }}</td>
            </ng-container>

            <ng-container matColumnDef="marked_by">
              <th mat-header-cell *matHeaderCellDef>Marked By</th>
              <td mat-cell *matCellDef="let record">{{ record.marked_by || '-' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['date', 'status', 'remarks', 'marked_by']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['date', 'status', 'remarks', 'marked_by']"></tr>
          </table>
        </div>
      </div>

      <!-- No Data Message -->
      <div class="no-data" *ngIf="!loading && showReport && attendanceHistory.length === 0">
        <mat-icon>info</mat-icon>
        <p>No attendance records found for this student</p>
        <small>Try adjusting the date range or check if attendance has been marked</small>
      </div>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button (click)="onBack()">
        <mat-icon>arrow_back</mat-icon> Back to List
      </button>
      <button mat-button (click)="printReport()">
        <mat-icon>print</mat-icon> Print
      </button>
      <button mat-button (click)="exportReport('pdf')">
        <mat-icon>picture_as_pdf</mat-icon> Export PDF
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Loading State -->
  <mat-card *ngIf="loading" class="loading-card">
    <mat-card-content>
      <mat-spinner></mat-spinner>
      <p>Loading attendance data...</p>
    </mat-card-content>
  </mat-card>
</div>

